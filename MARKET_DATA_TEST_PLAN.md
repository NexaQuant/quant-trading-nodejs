# Binance API项目 - 市场数据功能测试计划

## 1. 项目背景与测试目标

本项目旨在为Binance交易平台提供一个稳定、高效的API服务，初期核心功能是市场数据的实时拉取与推送。本次测试计划主要针对已完成的Node.js后端API的市场数据相关功能进行全面验证。

**核心测试目标：**

*   **WebSocket连接稳定性**：验证WebSocket连接的建立、维持、断线重连（包括24小时自动重连机制）以及心跳机制的可靠性。
*   **数据准确性与完整性**：确保通过WebSocket接收到的市场数据（如K线、深度、最新成交等）与Binance官方数据一致，无丢失、无错误、无延迟（在可接受范围内）。
*   **订阅与取消订阅功能**：验证单一及多个交易对的订阅和取消订阅功能的正确性。
*   **REST API辅助功能**：验证通过REST API获取必要信息（如服务器时间、交易规则）的准确性。
*   **错误处理与日志记录**：检验系统在各种异常情况下的错误处理能力和日志记录的完整性与有效性。
*   **性能与资源消耗**：初步评估在高并发或长时间运行情况下，系统的性能表现和资源（CPU、内存）占用情况。
*   **部署与配置**：验证在PM2和Nginx环境下的部署配置是否正确，服务能否正常启动和运行。

## 2. 测试范围

### 2.1. 功能范围

*   **WebSocket模块 (<mcsymbol name="WebSocketClient" filename="WebSocketClient.ts" path="src/core/WebSocketClient.ts" startline="N/A" type="class"></mcsymbol>)**：
    *   连接建立与认证（如果Binance API需要）。
    *   交易对订阅 (单个/多个)。
    *   交易对取消订阅 (单个/多个)。
    *   心跳机制 (Ping/Pong)。
    *   自动重连机制 (网络波动、服务器重启、24小时强制重连)。
    *   消息接收与解析。
    *   错误处理 (连接失败、订阅失败等)。
*   **REST API客户端模块 (<mcsymbol name="ApiClient" filename="ApiClient.ts" path="src/core/ApiClient.ts" startline="N/A" type="class"></mcsymbol>)**：
    *   获取服务器时间。
    *   获取交易规则/交易对信息。
    *   HMAC签名正确性。
    *   API速率限制处理 (初步验证，非压力测试)。
*   **市场数据服务模块 (<mcsymbol name="MarketDataService" filename="MarketDataService.ts" path="src/services/MarketDataService.ts" startline="N/A" type="class"></mcsymbol>)**：
    *   数据格式化与转换 (如有)。
    *   数据推送逻辑 (通过WebSocket推送给前端或其他消费者)。
*   **配置模块 (<mcsymbol name="config" filename="index.ts" path="src/config/index.ts" startline="N/A" type="variable"></mcsymbol>)**：
    *   环境变量加载与验证 (`dotenv`, `zod`)。
    *   API Key/Secret的安全使用。
*   **日志模块 (<mcsymbol name="logger" filename="logger.ts" path="src/utils/logger.ts" startline="N/A" type="variable"></mcsymbol>)**：
    *   不同日志级别的记录 (info, error, warn, debug)。
    *   关键操作和错误的日志输出。
*   **部署相关**：
    *   PM2 (`ecosystem.config.js`) 配置与运行。
    *   Nginx反向代理配置 (WebSocket `ws://` 和 REST API `http://` 或 `https://`)。

### 2.2. 非功能范围 (初步)

*   **稳定性测试**：长时间运行观察 (例如，连续运行24-72小时)。
*   **基本性能观察**：在少量并发连接下的CPU和内存使用情况。
*   **安全性**：API密钥不暴露，基础的服务器安全配置。

### 2.3. 本次测试不包含的范围

*   订单管理功能 (创建订单、取消订单、查询订单等)。
*   账户信息查询功能 (余额、持仓等)。
*   完整的前端UI交互测试 (本次主要关注后端API接口的正确性，前端仅作为数据接收验证的辅助)。
*   大规模并发压力测试和性能基准测试。
*   详细的安全渗透测试。

## 3. 测试策略与方法

*   **集成测试**：重点测试各模块之间的接口调用和数据流转。
*   **系统测试**：在类生产环境中，将整个后端系统作为一个整体进行测试。
*   **功能测试**：通过构造不同的输入和场景，验证各项功能是否符合预期。
*   **异常测试**：模拟网络中断、API错误、无效输入等异常情况，验证系统的容错和恢复能力。
*   **长时间运行测试**：验证系统在长时间运行下的稳定性和资源泄露情况。
*   **手动测试为主，辅以脚本验证**：大部分功能点通过Postman、WebSocket客户端工具（如`wscat`）进行手动测试，部分重复性操作可编写简单脚本辅助。

## 4. 测试环境与准备

*   **测试服务器**：一台配置与生产环境相似的云服务器或虚拟机。
    *   操作系统：Linux (推荐)
    *   安装Node.js (版本与开发环境一致)
    *   安装PM2
    *   安装Nginx
*   **网络环境**：公网可访问，确保可以连接到Binance API服务器。
*   **Binance API凭证**：准备一套用于测试的API Key和Secret (如果Binance提供沙箱环境，优先使用沙箱；否则使用真实账户，但注意风险控制，仅进行数据读取操作)。
*   **测试工具**：
    *   Postman: 用于测试REST API接口。
    *   WebSocket客户端工具 (如 Simple WebSocket Client Chrome插件, `wscat`, 或自定义脚本): 用于测试WebSocket连接和数据流。
    *   SSH客户端: 用于登录服务器进行部署和日志查看。
    *   代码编辑器/IDE: 查看和修改配置文件。
*   **前端应用 (可选)**：一个简单的前端页面，能够连接后端WebSocket并展示接收到的市场数据，辅助验证数据推送。
*   **项目代码**：最新稳定版的后端API代码。
*   **部署文档**：参考项目 <mcfile name="README.md" path="d:\node.js API\README.md"></mcfile> 中的部署指南。

## 5. 关键测试用例与场景 (示例)

| 用例ID   | 测试模块        | 测试描述                                                                 | 预置条件                                  | 操作步骤                                                                                                                               | 预期结果                                                                                                                                                                                             | 量化指标 (示例)                                                                                                | 优先级 | 状态     |
|----------|-----------------|--------------------------------------------------------------------------|-------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|----------|
| TC_WS_001| WebSocket连接   | 成功建立WebSocket连接                                                      | 后端服务已启动，网络通畅                      | 使用WebSocket客户端连接到 `ws://<your_server_ip_or_domain>/ws`                                                                         | 连接成功，无错误日志。                                                                                                                                                                                   | 连接成功率: 100%                                                                                                                                                                                     | 高       | ☐ 未测试 |
| TC_WS_002| WebSocket连接   | WebSocket连接失败 (后端服务未启动)                                           | 后端服务未启动                              | 使用WebSocket客户端连接                                                                                                                  | 连接失败，客户端提示错误，后端无相关日志或有启动失败日志。                                                                                                                                                           | -                                                                                                                                                                                                    | 高       | ☐ 未测试 |
| TC_WS_003| 订阅交易对    | 成功订阅单个有效交易对 (如 BTCUSDT 的K线)                                    | WebSocket已连接                             | 发送订阅请求: `{"method":"SUBSCRIBE","params":["btcusdt@kline_1m"],"id":1}`                                                        | 收到订阅成功确认；开始接收该交易对的K线数据；数据格式正确。                                                                                                                                                             | 数据接收延迟 < 500ms (与Binance官方对比)                                                                                                                                                               | 高       | ☐ 未测试 |
| TC_WS_004| 订阅交易对    | 订阅无效交易对                                                               | WebSocket已连接                             | 发送订阅请求: `{"method":"SUBSCRIBE","params":["invalid_symbol@kline_1m"],"id":2}`                                                 | 收到订阅失败的错误消息或无响应，后端日志记录错误。                                                                                                                                                               | -                                                                                                                                                                                                    | 中       | ☐ 未测试 |
| TC_WS_005| 订阅交易对    | 同时订阅多个有效交易对                                                         | WebSocket已连接                             | 发送订阅请求: `{"method":"SUBSCRIBE","params":["btcusdt@kline_1m", "ethusdt@depth"],"id":3}`                                       | 收到各交易对订阅成功的确认；分别接收到BTC K线和ETH深度数据。                                                                                                                                                         | -                                                                                                                                                                                                    | 高       | ☐ 未测试 |
| TC_WS_006| 取消订阅      | 成功取消已订阅的交易对                                                         | 已成功订阅某交易对 (如 btcusdt@kline_1m)      | 发送取消订阅请求: `{"method":"UNSUBSCRIBE","params":["btcusdt@kline_1m"],"id":4}`                                                  | 收到取消订阅成功确认；不再接收该交易对的数据。                                                                                                                                                                 | -                                                                                                                                                                                                    | 高       | ☐ 未测试 |
| TC_WS_007| 心跳机制      | WebSocket连接长时间保持，心跳正常                                              | WebSocket已连接并订阅数据                   | 保持连接10分钟以上，观察客户端和服务端日志。                                                                                                         | 连接保持，期间有Ping/Pong交互日志，数据持续接收。                                                                                                                                                              | Ping/Pong间隔符合预期 (如Binance要求3分钟内有交互)                                                                                                                                                     | 高       | ☐ 未测试 |
| TC_WS_008| 自动重连      | 网络短暂中断后自动重连并恢复订阅                                                 | WebSocket已连接并订阅数据                   | 模拟网络中断 (如禁用网卡几秒再启用) 或重启后端服务。                                                                                               | 客户端尝试重连，成功后自动重新订阅之前的交易对，并继续接收数据。后端日志记录重连过程。                                                                                                                                     | 重连成功率: 100% (3次尝试内)；重连时间 < 30秒                                                                                                                                                            | 高       | ☐ 未测试 |
| TC_WS_009| 24小时重连    | WebSocket连接运行接近24小时自动断开并重连                                        | WebSocket已连接并订阅数据，服务已运行接近24小时 | 监控服务运行，观察24小时周期的重连行为。                                                                                                           | 连接在预期时间点（如Binance规定的24小时）断开，并立即自动重连成功，恢复订阅和数据流。                                                                                                                                   | 自动重连成功率: 100%                                                                                                                                                                                   | 高       | ☐ 未测试 |
| TC_API_001| REST API      | 获取服务器时间接口正常                                                           | 后端服务已启动                              | 使用Postman访问 `http://<server>/api/v1/time`                                                                                          | 返回200 OK，响应体包含正确的服务器时间，与Binance时间误差小。                                                                                                                                                     | 响应时间 < 500ms                                                                                                                                                                                     | 高       | ☐ 未测试 |
| TC_LOG_001| 日志记录      | 关键操作 (连接、订阅、错误) 均有日志记录                                         | -                                         | 执行各种正常和异常操作。                                                                                                                     | 查看后端日志文件 (`pm2 logs <app_name>`)，应包含对应操作的info、error、warn级别日志。                                                                                                                            | 日志覆盖率 > 95% 关键路径                                                                                                                                                                              | 高       | ☐ 未测试 |
| TC_DEP_001| 部署          | PM2成功启动和管理应用                                                          | 代码已部署到服务器，`ecosystem.config.js`已配置 | 执行 `pm2 start ecosystem.config.js`                                                                                                         | 应用状态为 `online`，日志输出正常。                                                                                                                                                                         | -                                                                                                                                                                                                    | 高       | ☐ 未测试 |
| TC_DEP_002| 部署          | Nginx反向代理WebSocket (wss/ws) 和 API (https/http) 正常                     | Nginx已配置并重载                           | 通过配置的域名/IP访问WebSocket和API接口。                                                                                                      | WebSocket连接成功，API请求正常响应。                                                                                                                                                                       | -                                                                                                                                                                                                    | 高       | ☐ 未测试 |
| TC_STB_001| 稳定性测试    | 系统长时间运行 (24小时) 后功能正常，无明显内存泄漏或CPU异常占用                  | 完成所有功能测试用例，系统稳定                | 保持服务运行24小时，期间进行少量随机订阅和API调用，监控服务器资源。                                                                                              | 24小时后，各项功能依然可用，CPU/内存使用率在合理范围，无持续增长趋势。                                                                                                                                             | CPU使用率峰值 < 70%；内存增长 < 10% (24h)                                                                                                                                                               | 中       | ☐ 未测试 |

## 6. 测试执行与数据收集

*   **执行人**：测试工程师，开发工程师协助。
*   **执行顺序**：先执行部署和基本连接测试，再执行核心功能测试，最后进行稳定性和异常测试。
*   **数据记录**：
    *   详细记录每个测试用例的执行步骤、实际结果、截图（如果需要）。
    *   收集后端PM2日志。
    *   监控服务器的CPU、内存使用情况。
    *   前端（如果使用）的控制台输出和网络请求信息。
    *   与Binance官方数据进行抽样对比，记录差异。

## 7. 缺陷管理与报告

*   **缺陷跟踪工具**：使用项目选定的缺陷管理工具 (如Jira, Trello, 或简单的Excel表格)。
*   **缺陷报告规范**：
    *   标题：清晰概括问题。
    *   复现步骤：详细描述如何重现该缺陷。
    *   实际结果：描述观察到的错误现象。
    *   预期结果：描述期望的正确行为。
    *   严重程度 (Blocker, Critical, Major, Minor, Trivial)。
    *   优先级 (High, Medium, Low)。
    *   附件：相关的日志、截图等。
*   **缺陷生命周期**：Open -> In Progress (Assigned) -> Fixed (Resolved) -> Retested (Verified) -> Closed / Reopened。
*   **测试报告**：测试结束后，输出测试总结报告，包括测试覆盖情况、通过率、遗留缺陷列表、风险评估和上线建议。

## 8. 测试时间计划与资源分配

*   **测试周期**：预计 X 天 (根据实际任务量和资源调整，例如：5-10个工作日)。
    *   环境准备与冒烟测试：Y 天
    *   第一轮功能测试：Z 天
    *   缺陷修复与回归测试：W 天
    *   稳定性测试：并行进行或额外 A 天
*   **测试人员**：
    *   项目经理 (1名)：整体协调，资源保障，风险把控。
    *   后端工程师 (1-2名)：部署支持，缺陷修复，技术答疑。
    *   前端工程师 (1名，若有前端辅助测试)：前端配置，UI问题排查。
    *   测试工程师 (1-2名)：测试计划细化，用例设计与执行，缺陷报告，测试报告撰写。

## 9. 测试退出标准

*   所有“高”优先级测试用例执行通过。
*   关键功能模块的测试覆盖率达到 95% 以上。
*   Blocker 和 Critical 级别的缺陷已全部修复并通过验证。
*   Major 级别缺陷修复率达到 80% 以上，剩余未修复的有明确的解决方案或可接受的规避措施，并得到项目相关方确认。
*   Minor 及以下级别缺陷根据项目实际情况决定是否修复。
*   系统在模拟生产环境下连续稳定运行超过 48 小时无严重问题。
*   测试报告已完成并评审通过。

## 10. 风险与预案

| 风险描述                                 | 可能性 | 影响程度 | 预案                                                                                               |
|------------------------------------------|--------|----------|----------------------------------------------------------------------------------------------------|
| Binance API接口变更或不稳定                | 中     | 高       | 及时关注Binance官方公告，预留时间进行适配和回归测试。与Binance技术支持建立联系渠道。                               |
| 测试环境与生产环境不一致导致测试结果失真     | 中     | 中       | 尽可能保持环境一致性，记录差异点并在测试报告中说明可能的影响。                                                       |
| 测试数据准备不足或不真实                   | 低     | 中       | 提前规划测试数据需求，尽可能使用真实场景数据或通过工具生成模拟数据。                                                   |
| 核心开发人员变动或资源不足                 | 低     | 高       | 做好知识传递和文档建设，项目经理及时协调资源。                                                                   |
| 测试过程中发现重大设计缺陷，导致大规模返工 | 低     | 高       | 加强前期需求评审和设计评审，测试尽早介入。若发生，项目经理需重新评估项目计划。                                           |
| 依赖的第三方服务 (如Nginx, PM2) 配置问题   | 中     | 中       | 运维工程师提前熟悉相关技术栈，准备好标准配置文件模板。                                                               |

---

**本文档将根据项目进展和实际情况持续更新。**